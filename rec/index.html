<!DOCTYPE html>
<html>
<head>
  <title>Receiver Page</title>
  <!-- Include Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
  <h1>Receiver Page</h1>
  <button id="answerButton">Answer Call</button>
  <audio id="myAudio" autoplay></audio>

  <script>
    // Initialize Firebase
    var firebaseConfig = {
        apiKey: "AIzaSyC1QgZw1hNhesqrq7gU-B4-IAKScY9ACdE",
    authDomain: "echo-b2f1f.firebaseapp.com",
    projectId: "echo-b2f1f",
    storageBucket: "echo-b2f1f.appspot.com",
    messagingSenderId: "795689625860",
    appId: "1:795689625860:web:9bcf69b393cc66ebdd4851",
    measurementId: "G-KZ2YBEV61X"
    };
    firebase.initializeApp(firebaseConfig);

    // Get a reference to the Firebase Realtime Database
    var database = firebase.database();
    var signalingRef = database.ref('calls');

    // Create local RTCPeerConnection
    var localConnection = new RTCPeerConnection();

    // Get local media stream
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(function(stream) {
        // Add local stream to connection
        stream.getTracks().forEach(function(track) {
          localConnection.addTrack(track, stream);
        });

        // Set local audio source
        var audioElement = document.getElementById('myAudio');
        audioElement.srcObject = stream;
      })
      .catch(function(error) {
        console.error('Error accessing media devices:', error);
      });

    // Handle answer button click event
    var answerButton = document.getElementById('answerButton');
    answerButton.addEventListener('click', function() {
      // Listen for new call
      signalingRef.on('child_added', function(snapshot) {
        var callId = snapshot.key;
        var callData = snapshot.val();

        if (callData.signalingData && callData.signalingData.type === 'offer') {
          // Create remote RTCSessionDescription using the received offer
          var remoteDescription = new RTCSessionDescription(callData.signalingData);

          // Set remote description on the local peer connection
          localConnection.setRemoteDescription(remoteDescription)
            .then(function() {
              // Create answer
              return localConnection.createAnswer();
            })
            .then(function(answer) {
              // Set local description
              return localConnection.setLocalDescription(answer);
            })
            .then(function() {
              // Update signaling data in Firebase Realtime Database
              return signalingRef.child(callId).child('signalingData').set({
                type: localConnection.localDescription.type,
                sdp: localConnection.localDescription.sdp
              });
            })
            .catch(function(error) {
              console.error('Error creating or setting local/remote description:', error);
            });
        }
      });
    });
  </script>
</body>
</html>
